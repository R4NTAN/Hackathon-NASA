<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Air and Weather Monitoring with Highlight</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<style>
:root{
  --bg:#f0f4f8;--panel:#fff;--accent:#0ea5e9;--accent-hover:#0284c7;
  --text:#0f172a;--muted:#6b7280;
  --ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;
}
html,body{height:100%;margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);}
.app{display:grid;grid-template-columns:380px 1fr;height:100vh;gap:0;}
#map{width:100%;height:100%;}

/* –ù–û–í–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –ü–ê–ù–ï–õ–Ü */
aside {
  background: var(--panel);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  border-radius: 0 20px 20px 0;
  box-shadow: 4px 0 25px rgba(0,0,0,0.1);
}

aside h1 {
  margin: 0;
  font-size: 1.4rem;
  color: var(--accent);
  text-align: center;
}

.card {
  background: rgba(14,165,233,0.05);
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(2,6,23,0.08);
}

.label {
  font-size: 0.9rem;
  color: var(--muted);
  margin-bottom: 4px;
}

.value {
  font-weight: 700;
  font-size: 1rem;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.btn {
  flex: 1;
  padding: 8px 12px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: .2s;
}
.btn.primary { background: var(--accent); color: #fff; }
.btn.primary:hover { background: var(--accent-hover); }
.btn.danger { background: #ef4444; color:#fff; }
.btn:hover { opacity: .9; }

.legend {
  background: #fff;
  padding: 12px;
  border-radius: 12px;
  font-size: 0.9rem;
  border: 1px solid rgba(2,6,23,0.08);
}
.legend-title { font-weight: 700; margin-bottom: 8px; }
.legend-item { display:flex; align-items:center; gap:8px; margin-bottom: 6px; }
.sw { width:18px; height:18px; border-radius:4px; display:inline-block; }
.sw.good { background:#00e400; }
.sw.moderate { background:#ffff00; }
.sw.unhealthy1 { background:#ff7e00; }
.sw.unhealthy2 { background:#ff0000; }

.footer {
  margin-top:auto;
  font-size:0.8rem;
  text-align:center;
  color: var(--muted);
}

/* —ñ–Ω—à—ñ —Å—Ç–∏–ª—ñ –ª–∏—à–∞—é—Ç—å—Å—è */
@media(max-width:900px){
  .app{grid-template-columns:1fr;}
  aside{position:absolute;left:8px;right:8px;top:8px;z-index:1000;}
}
.weather-icon{width:30px;height:30px;vertical-align:middle;margin-right:4px;}
.weather-popup-title {
  background: #ffe033;
  color: #333;
  font-weight: bold;
  border-radius: 6px 6px 0 0;
  padding: 6px 0;
  text-align: center;
  margin: -8px -8px 8px -8px;
  font-size: 1.03rem;
  border-bottom: 1.5px solid #eee;
}
.weather-popup-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1rem;
}
.weather-popup-table td {
  padding: 2px 8px 2px 0;
  font-size: 1rem;
  vertical-align: top;
}
.weather-popup-table td:first-child {
  color: #333;
  font-weight: 400;
  white-space: nowrap;
}
.weather-popup-table td:last-child {
  font-weight: bold;
  padding-left: 8px;
  color: #222;
}
.leaflet-popup-content-wrapper {
  border-radius: 8px;
}
.select-map {
  width: 100%;
  padding: 8px;
  border-radius: 10px;
  border: 1px solid rgba(2,6,23,0.1);
  font-size: 1rem;
}
.marker-dot {
  display:inline-block;
  width:14px;
  height:14px;
  border:2px solid #fff;
  border-radius:50%;
  box-shadow:0 0 4px rgba(0,0,0,0.3);
  transition: border-color 0.2s;
}
.marker-dot:active {
  border-color:#888; /* –ø—Ä–∏ –∫–ª—ñ–∫—É —Å—Ç–∞—î —Å—ñ—Ä–æ—é */
}
</style>
</head>
<body>
<div class="app">

<!-- üîπ –ù–û–í–ê –ü–ê–ù–ï–õ–¨ -->
<aside>
  <h1>üåç Air & Weather</h1>

  <div class="card">
    <div class="label">üìç Coordinates</div>
    <div id="coords" class="value">Click on the map or search</div>
  </div>

  <div class="card">
    <div class="label">üîé Zoom</div>
    <div id="zoom" class="value">-</div>
  </div>

  <div class="card">
    <div class="label">üó∫Ô∏è Map Type</div>
    <select id="mapType" class="select-map">
      <option value="light">Light</option>
      <option value="satellite">Satellite</option>
      <option value="terrain">Terrain</option>
      <option value="dark">Dark</option>
    </select>
  </div>

  <div class="controls">
    <button id="locateBtn" class="btn primary">üìç Locate me</button>
    <button id="resetBtn" class="btn">üîÅ Reset</button>
    <button id="clearBtn" class="btn danger">üóë Clear</button>
  </div>

  <div class="legend">
    <div class="legend-title">AQI Levels</div>
    <div class="legend-item"><span class="sw good"></span> Good (0‚Äì50)</div>
    <div class="legend-item"><span class="sw moderate"></span> Moderate (51‚Äì100)</div>
    <div class="legend-item"><span class="sw unhealthy1"></span> Unhealthy (101‚Äì150)</div>
    <div class="legend-item"><span class="sw unhealthy2"></span> Very Unhealthy (151+)</div>
  </div>

  <div class="card">
    <div class="label">üìä Data status</div>
    <div id="statusText" class="value">Ready</div>
  </div>

  <div class="footer">üåê OpenAQ + OpenWeatherMap</div>
</aside>

<main><div id="map"></div></main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
const OPENWEATHER_API_KEY='f96276a10ff40c3e256ba7991d7df571';

// --- Map Layers ---
const layers = {
  light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19, attribution:'&copy; CARTO'}),
  satellite: L.layerGroup([
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom:19, attribution:'Imagery ¬© Esri'
    }),
    L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
      maxZoom:19, attribution:'Labels ¬© Esri'
    })
  ]),
  terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {maxZoom:17, attribution:'Map data: &copy; OpenTopoMap'}),
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {maxZoom:19, attribution:'&copy; CARTO'})
};

const map = L.map('map',{center:[45,-95],zoom:3});
let currentBase = layers.light;
currentBase.addTo(map);

const mapTypeSelect=document.getElementById('mapType');
mapTypeSelect.addEventListener('change',()=>{
  map.removeLayer(currentBase);
  currentBase = layers[mapTypeSelect.value];
  currentBase.addTo(map);
});

const coordsEl=document.getElementById('coords');
const zoomEl=document.getElementById('zoom');
const statusText=document.getElementById('statusText');

let singleMarker=null;
const cityMarkers=[];

function setStatus(t){statusText.textContent=t;}
function updateZoom(){zoomEl.textContent=map.getZoom();}
map.on('zoomend',updateZoom);updateZoom();

document.getElementById('resetBtn').addEventListener('click',()=>map.setView([45,-95],3));
document.getElementById('locateBtn').addEventListener('click',()=>map.locate({setView:true,maxZoom:10}));
document.getElementById('clearBtn').addEventListener('click',()=>{
  if(singleMarker){map.removeLayer(singleMarker);singleMarker=null;}
  cityMarkers.forEach(c=>map.removeLayer(c.marker));
  setStatus('All markers cleared');
});

map.on('locationfound',e=>{
  coordsEl.textContent=`${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
  fetchAndShowSingle(e.latlng.lat,e.latlng.lng,'You are here');
});
map.on('click',e=>{
  coordsEl.textContent=`${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
  fetchAndShowSingle(e.latlng.lat,e.latlng.lng,`Point ${e.latlng.lat.toFixed(2)},${e.latlng.lng.toFixed(2)}`);
});

// --- AQI ---
function pm25ToAQI(pm25){
  const breaks=[{cLow:0,cHigh:12,aLow:0,aHigh:50},{cLow:12.1,cHigh:35.4,aLow:51,aHigh:100},{cLow:35.5,cHigh:55.4,aLow:101,aHigh:150},{cLow:55.5,cHigh:150.4,aLow:151,aHigh:200},{cLow:150.5,cHigh:250.4,aLow:201,aHigh:300},{cLow:250.5,cHigh:350.4,aLow:301,aHigh:400},{cLow:350.5,cHigh:500.4,aLow:401,aHigh:500}];
  for(const b of breaks){if(pm25>=b.cLow&&pm25<=b.cHigh){const aqi=Math.round(((b.aHigh-b.aLow)/(b.cHigh-b.cLow))*(pm25-b.cLow)+b.aLow);let cat='Unknown';if(aqi<=50)cat='Good';else if(aqi<=100)cat='Moderate';else if(aqi<=150)cat='Unhealthy for sensitive';else if(aqi<=200)cat='Unhealthy';else cat='Hazardous';return {aqi,category:cat};}}
  return {aqi:null,category:'N/A'};
}
function chooseColorFromAQ(pm25){if(pm25<=12)return'#00e400';if(pm25<=35.4)return'#ffff00';if(pm25<=55.4)return'#ff7e00';return'#ff0000';}
function weatherIconUrl(icon){return `https://openweathermap.org/img/wn/${icon}.png`;}

// --- Custom Marker ---
function createCustomMarker(color) {
  return L.divIcon({
    className: "custom-marker",
    html: `<span class="marker-dot" style="
      background:${color};
    "></span>`,
    iconSize: [16, 16],
    iconAnchor: [8, 8],
    popupAnchor: [0, -8]
  });
}

// --- API ---
async function fetchOpenAQ(lat,lon){
  try{
    const r=await fetch(`https://api.openaq.org/v3/latest?coordinates=${lat},${lon}&radius=50000&limit=10`);
    const d=await r.json();
    if(!d.results||d.results.length===0)return[{parameter:'pm25',value:0,unit:'¬µg/m¬≥'}];
    const arr=[];d.results.forEach(r=>r.measurements.forEach(m=>arr.push({parameter:m.parameter,value:m.value,unit:m.unit})));
    return arr;
  }catch(e){console.error(e);return[{parameter:'pm25',value:0,unit:'¬µg/m¬≥'}];}
}

async function fetchWeather(lat,lon){
  try{
    const r=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OPENWEATHER_API_KEY}&lang=en`);
    const d=await r.json();if(!d.main)return null;
    return{temp:d.main.temp,humidity:d.main.humidity,pressure:d.main.pressure,description:d.weather[0].description,icon:d.weather[0].icon,clouds:d.clouds?d.clouds.all:null,wind_deg:d.wind?d.wind.deg:null,wind_speed:d.wind?d.wind.speed:null,country:d.sys?d.sys.country:'',name:d.name||''};
  }catch(e){console.error(e);return null;}
}

// --- Popups ---
function buildPopupHtml(label,meas,w){
  let pm=meas.find(m=>m.parameter==='pm25'||m.parameter==='pm2.5');
  let aqiObj=pm?pm25ToAQI(pm.value):null;
  let aqiStr=aqiObj?`${aqiObj.aqi} ‚Äî ${aqiObj.category}`:'';
  let html=`<div class="weather-popup-title">${label||'Weather'}</div><table class="weather-popup-table">
  <tr><td>Country</td><td>${w?.country||'-'}</td></tr>
  <tr><td>Temp</td><td>${w?.temp?.toFixed(1)||'-'}¬∞C</td></tr>
  <tr><td>Clouds</td><td>${w?.clouds??'-'}%</td></tr>
  <tr><td>Humidity</td><td>${w?.humidity??'-'}%</td></tr>
  <tr><td>Pressure</td><td>${w?.pressure??'-'} hPa</td></tr>
  <tr><td>Wind</td><td>${w?.wind_speed?.toFixed(1)||'-'} m/s</td></tr>
  ${aqiObj?`<tr><td>AQI</td><td>${aqiStr}</td></tr>`:''}
  <tr><td colspan="2" style="text-align:center;">${w?.icon?`<img class="weather-icon" src="${weatherIconUrl(w.icon)}"/>`:''} ${w?.description||''}</td></tr>
  </table>`;
  return html;
}

// --- Markers ---
function createOrUpdateSingleMarker(lat,lon,label,meas,w){
  if(singleMarker){map.removeLayer(singleMarker);singleMarker=null;}
  let pm=meas.find(m=>m.parameter==='pm25'||m.parameter==='pm2.5');
  let color=pm?chooseColorFromAQ(pm.value):'#999';
  singleMarker=L.marker([lat,lon],{icon:createCustomMarker(color)})
    .addTo(map)
    .bindPopup(buildPopupHtml(label,meas,w),{maxWidth:340,minWidth:240})
    .on("click",()=>map.setView([lat,lon],8,{animate:true}));
}
function createOrUpdateCityMarker(lat,lon,label,meas,w){
  let pm=meas.find(m=>m.parameter==='pm25'||m.parameter==='pm2.5');
  let color=pm?chooseColorFromAQ(pm.value):'#999';
  let marker=L.marker([lat,lon],{icon:createCustomMarker(color)})
    .addTo(map)
    .bindPopup(buildPopupHtml(label,meas,w),{maxWidth:340,minWidth:240})
    .on("click",()=>map.setView([lat,lon],8,{animate:true}));
  cityMarkers.push({marker});
}

// --- Fetchers ---
async function fetchAndShowSingle(lat,lon,label){
  setStatus('Loading...');
  const [m,w]=await Promise.all([fetchOpenAQ(lat,lon),fetchWeather(lat,lon)]);
  createOrUpdateSingleMarker(lat,lon,label,m,w);
  setStatus('Data updated');
}
async function fetchAndShowCity(lat,lon,label){
  const [m,w]=await Promise.all([fetchOpenAQ(lat,lon),fetchWeather(lat,lon)]);
  createOrUpdateCityMarker(lat,lon,label,m,w);
}

// --- Cities ---
const predefined = [
  // –°—Ö—ñ–¥–Ω–µ —É–∑–±–µ—Ä–µ–∂–∂—è –°–®–ê
  {name:'New York', coords:[40.7128,-74.0060]},
  {name:'Boston', coords:[42.3601,-71.0589]},
  {name:'Philadelphia', coords:[39.9526,-75.1652]},
  {name:'Washington', coords:[38.9072,-77.0369]},
  {name:'Baltimore', coords:[39.2904,-76.6122]},
  {name:'Pittsburgh', coords:[40.4406,-79.9959]},
  {name:'Buffalo', coords:[42.8864,-78.8784]},
  {name:'Richmond', coords:[37.5407,-77.4360]},

  // –ü—ñ–≤–¥–µ–Ω–Ω–∏–π —Å—Ö—ñ–¥ –°–®–ê
  {name:'Miami', coords:[25.7617,-80.1918]},
  {name:'Orlando', coords:[28.5383,-81.3792]},
  {name:'Tampa', coords:[27.9506,-82.4572]},
  {name:'Jacksonville', coords:[30.3322,-81.6557]},
  {name:'Atlanta', coords:[33.7490,-84.3880]},
  {name:'Charlotte', coords:[35.2271,-80.8431]},
  {name:'Raleigh', coords:[35.7796,-78.6382]},
  {name:'Nashville', coords:[36.1627,-86.7816]},
  {name:'New Orleans', coords:[29.9511,-90.0715]},

  // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ñ —à—Ç–∞—Ç–∏
  {name:'Chicago', coords:[41.8781,-87.6298]},
  {name:'Detroit', coords:[42.3314,-83.0458]},
  {name:'Cleveland', coords:[41.4993,-81.6944]},
  {name:'Columbus', coords:[39.9612,-82.9988]},
  {name:'Indianapolis', coords:[39.7684,-86.1581]},
  {name:'Minneapolis', coords:[44.9778,-93.2650]},
  {name:'St. Louis', coords:[38.6270,-90.1994]},
  {name:'Kansas City', coords:[39.0997,-94.5786]},
  {name:'Milwaukee', coords:[43.0389,-87.9065]},

  // –¢–µ—Ö–∞—Å
  {name:'Dallas', coords:[32.7767,-96.7970]},
  {name:'Houston', coords:[29.7604,-95.3698]},
  {name:'San Antonio', coords:[29.4241,-98.4936]},
  {name:'Austin', coords:[30.2672,-97.7431]},
  {name:'El Paso', coords:[31.7619,-106.4850]},

  // –ó–∞—Ö—ñ–¥ –°–®–ê
  {name:'Denver', coords:[39.7392,-104.9903]},
  {name:'Phoenix', coords:[33.4484,-112.0740]},
  {name:'Tucson', coords:[32.2226,-110.9747]},
  {name:'Salt Lake City', coords:[40.7608,-111.8910]},
  {name:'Las Vegas', coords:[36.1699,-115.1398]},
  {name:'Los Angeles', coords:[34.0522,-118.2437]},
  {name:'San Diego', coords:[32.7157,-117.1611]},
  {name:'San Francisco', coords:[37.7749,-122.4194]},
  {name:'San Jose', coords:[37.3382,-121.8863]},
  {name:'Portland', coords:[45.5051,-122.6750]},
  {name:'Seattle', coords:[47.6062,-122.3321]},

  // –ö–∞–Ω–∞–¥–∞
  {name:'Vancouver', coords:[49.2827,-123.1207]},
  {name:'Toronto', coords:[43.6532,-79.3832]},
  {name:'Ottawa', coords:[45.4215,-75.6992]},
  {name:'Montreal', coords:[45.5019,-73.5674]},
  {name:'Quebec City', coords:[46.8139,-71.2080]},
  {name:'Calgary', coords:[51.0447,-114.0719]},
  {name:'Edmonton', coords:[53.5461,-113.4938]},
  {name:'Winnipeg', coords:[49.8951,-97.1384]},
  {name:'Halifax', coords:[44.6488,-63.5752]},

  // –ú–µ–∫—Å–∏–∫–∞
  {name:'Mexico City', coords:[19.4326,-99.1332]},
  {name:'Guadalajara', coords:[20.6597,-103.3496]},
  {name:'Monterrey', coords:[25.6866,-100.3161]},
  {name:'Tijuana', coords:[32.5149,-117.0382]},
  {name:'Cancun', coords:[21.1619,-86.8515]},
  {name:'M√©rida', coords:[20.9674,-89.5926]},

  // –ö—É–±–∞
  {name:'Havana', coords:[23.1136,-82.3666]},
  {name:'Santiago de Cuba', coords:[20.0169,-75.8302]}
];


(async()=>{
  setStatus('Loading cities...');
  for(const c of predefined){
    await new Promise(r=>setTimeout(r,180));
    fetchAndShowCity(c.coords[0],c.coords[1],c.name);
  }
  setStatus('All cities loaded');
})();

// --- Search ---
if(typeof L.Control.Geocoder!=='undefined'){
  L.Control.geocoder({
    defaultMarkGeocode:false,
    placeholder:'Search for city or address...'
  }).on('markgeocode',function(e){
    const latlng=e.geocode.center;
    const name=e.geocode.name||'Place';
    map.setView(latlng,10);
    fetchAndShowSingle(latlng.lat,latlng.lng,name);
  }).addTo(map);
}
</script>
</body>
</html>

