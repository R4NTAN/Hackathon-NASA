<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Air and Weather Monitoring with Highlight</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<style>
:root{
  --bg:#f0f4f8;--panel:#fff;--accent:#0ea5e9;--accent-hover:#0284c7;
  --text:#0f172a;--muted:#6b7280;
  --ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;
}
html,body{height:100%;margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);}
.app{display:grid;grid-template-columns:380px 1fr;height:100vh;gap:0;}
aside{
  background:var(--panel);padding:25px;box-shadow:4px 0 30px rgba(2,6,23,0.1);
  display:flex;flex-direction:column;gap:16px;border-radius:0 20px 20px 0;
}
aside h1{margin:0;font-size:1.5rem;color:var(--accent);}
.info{background:linear-gradient(180deg,rgba(14,165,233,0.05),rgba(2,6,23,0.01));border-radius:15px;padding:14px;border:1px solid rgba(2,6,23,0.05);}
.label{font-size:.85rem;color:var(--muted);}
.value{font-weight:700;font-size:1.05rem;}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;}
.btn{
  background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;
  transition:0.2s;
}
.btn:hover{background:var(--accent-hover);}
.btn.ghost{background:transparent;border:1px solid rgba(2,6,23,0.1);color:var(--text);}
.legend{padding:12px;border-radius:12px;background:#fff;border:1px solid rgba(2,6,23,0.05);}
.legend-item{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.sw{width:20px;height:20px;border-radius:5px;}
#map{width:100%;height:100%;}
.footer{margin-top:auto;font-size:.85rem;color:var(--muted);}
@media(max-width:900px){.app{grid-template-columns:1fr;}aside{position:absolute;left:8px;right:8px;top:8px;z-index:1000;}}
.weather-icon{width:30px;height:30px;vertical-align:middle;margin-right:4px;}
.weather-popup-title {
  background: #ffe033;
  color: #333;
  font-weight: bold;
  border-radius: 6px 6px 0 0;
  padding: 6px 0;
  text-align: center;
  margin: -8px -8px 8px -8px;
  font-size: 1.03rem;
  border-bottom: 1.5px solid #eee;
}
.weather-popup-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1rem;
}
.weather-popup-table td {
  padding: 2px 8px 2px 0;
  font-size: 1rem;
  vertical-align: top;
}
.weather-popup-table td:first-child {
  color: #333;
  font-weight: 400;
  white-space: nowrap;
}
.weather-popup-table td:last-child {
  font-weight: bold;
  padding-left: 8px;
  color: #222;
}
.leaflet-popup-content-wrapper {
  border-radius: 8px;
}
</style>
</head>
<body>
<div class="app">
<aside>
<h1>Air and Weather Monitoring</h1>

<div class="info"><div class="label">Coordinates</div><div id="coords" class="value">Click on the map or search</div></div>
<div class="info"><div class="label">Zoom</div><div id="zoom" class="value">-</div></div>

<div class="controls">
  <button id="locateBtn" class="btn">üìç Locate me</button>
  <button id="resetBtn" class="btn ghost">üîÅ Reset</button>
  <button id="clearBtn" class="btn ghost">üóë Clear</button>
</div>

<div class="legend">
<div style="font-weight:700;margin-bottom:8px">AQI Legend</div>
<div class="legend-item"><div class="sw" style="background:#00e400"></div><div>0‚Äì50 Good</div></div>
<div class="legend-item"><div class="sw" style="background:#ffff00"></div><div>51‚Äì100 Moderate</div></div>
<div class="legend-item"><div class="sw" style="background:#ff7e00"></div><div>101‚Äì150 Unhealthy (sensitive)</div></div>
<div class="legend-item"><div class="sw" style="background:#ff0000"></div><div>151+ Unhealthy</div></div>
</div>

<div class="info" id="statusBox"><div class="label">Data status</div><div id="statusText" class="value">Ready</div></div>
<div class="footer">Data: OpenAQ + OpenWeatherMap ‚Ä¢ Click map for new markers</div>
</aside>
<main><div id="map"></div></main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
const OPENWEATHER_API_KEY='f96276a10ff40c3e256ba7991d7df571';
const map=L.map('map').setView([45,-95],3);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; CARTO',maxZoom:19}).addTo(map);

const coordsEl=document.getElementById('coords');
const zoomEl=document.getElementById('zoom');
const statusText=document.getElementById('statusText');

// --- Only one user marker and circle (user click/locate), cities are separate
let singleMarker = null;
let singleCircle = null;
// Store city markers to manage them separately
const cityMarkers = [];

function setStatus(text){statusText.textContent=text;}
function updateZoom(){zoomEl.textContent=map.getZoom();}
map.on('zoomend',updateZoom);updateZoom();

document.getElementById('resetBtn').addEventListener('click',()=>map.setView([45,-95],3));
document.getElementById('locateBtn').addEventListener('click',()=>map.locate({setView:true,maxZoom:10}));
document.getElementById('clearBtn').addEventListener('click',()=>{
  if(singleMarker) { map.removeLayer(singleMarker); singleMarker = null; }
  if(singleCircle) { map.removeLayer(singleCircle); singleCircle = null; }
  setStatus('All markers cleared');
});

map.on('locationfound',e=>{
  coordsEl.textContent = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
  fetchAndShowSingle(e.latlng.lat,e.latlng.lng,'You are here');
});
map.on('click',e=>{
  coordsEl.textContent = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
  fetchAndShowSingle(e.latlng.lat,e.latlng.lng,`Point ${e.latlng.lat.toFixed(2)},${e.latlng.lng.toFixed(2)}`);
});

// Helper functions
function pm25ToAQI(pm25){
  const breaks=[{cLow:0,cHigh:12,aLow:0,aHigh:50},{cLow:12.1,cHigh:35.4,aLow:51,aHigh:100},{cLow:35.5,cHigh:55.4,aLow:101,aHigh:150},{cLow:55.5,cHigh:150.4,aLow:151,aHigh:200},{cLow:150.5,cHigh:250.4,aLow:201,aHigh:300},{cLow:250.5,cHigh:350.4,aLow:301,aHigh:400},{cLow:350.5,cHigh:500.4,aLow:401,aHigh:500}];
  for(const b of breaks){ if(pm25>=b.cLow&&pm25<=b.cHigh){const aqi=Math.round(((b.aHigh-b.aLow)/(b.cHigh-b.cLow))*(pm25-b.cLow)+b.aLow);let cat='Unknown'; if(aqi<=50)cat='Good'; else if(aqi<=100)cat='Moderate'; else if(aqi<=150)cat='Unhealthy for sensitive'; else if(aqi<=200)cat='Unhealthy'; else cat='Hazardous'; return {aqi,category:cat};} }
  return {aqi:null,category:'N/A'};
}
function chooseColorFromAQ(pm25){if(pm25<=12)return'#00e400';if(pm25<=35.4)return'#ffff00';if(pm25<=55.4)return'#ff7e00';return'#ff0000';}
function weatherIconUrl(icon){return `http://openweathermap.org/img/wn/${icon}.png`;}

async function fetchOpenAQ(lat,lon){
  try{
    const resp=await fetch(`https://api.openaq.org/v3/latest?coordinates=${lat},${lon}&radius=50000&limit=10`);
    const data=await resp.json();
    if(!data.results||data.results.length===0) return [{parameter:'pm25',value:0,unit:'¬µg/m¬≥'}];
    const measurements=[];
    data.results.forEach(r=>r.measurements.forEach(m=>measurements.push({parameter:m.parameter,value:m.value,unit:m.unit})));
    return measurements;
  }catch(e){console.error(e); return [{parameter:'pm25',value:0,unit:'¬µg/m¬≥'}];}
}

async function fetchWeather(lat,lon){
  try{
    const resp=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OPENWEATHER_API_KEY}&lang=en`);
    const d=await resp.json();
    if(!d.main)return null;
    return {
      temp: d.main.temp,
      humidity: d.main.humidity,
      pressure: d.main.pressure,
      description: d.weather[0].description,
      icon: d.weather[0].icon,
      clouds: d.clouds ? d.clouds.all : null,
      wind_deg: d.wind ? d.wind.deg : null,
      wind_speed: d.wind ? d.wind.speed : null,
      country: d.sys && d.sys.country ? d.sys.country : '',
      name: d.name || ''
    };
  }catch(e){console.error(e); return null;}
}

// Popup for both user and city markers
function buildPopupHtml(label,measurements,weather){
  let pm=measurements.find(m=>m.parameter==='pm25'||m.parameter==='pm2.5');
  let aqiObj = pm ? pm25ToAQI(pm.value) : null;
  let aqiStr = aqiObj ? `${aqiObj.aqi} ‚Äî ${aqiObj.category}` : '';
  let cityTitle = `
    <div class="weather-popup-title">${label||'Weather'}</div>
  `;
  let table = `<table class="weather-popup-table">
    <tr><td>Country</td><td>${weather && weather.country ? weather.country : '-'}</td></tr>
    <tr><td>Temperature</td><td>${weather && weather.temp!==undefined ? weather.temp.toFixed(1) + '¬∞C' : '-'}</td></tr>
    <tr><td>Clouds</td><td>${weather && weather.clouds!==null && weather.clouds!==undefined ? weather.clouds + '%' : '-'}</td></tr>
    <tr><td>Humidity</td><td>${weather && weather.humidity!==undefined ? weather.humidity + '%' : '-'}</td></tr>
    <tr><td>Pressure</td><td>${weather && weather.pressure!==undefined ? weather.pressure + ' hPa' : '-'}</td></tr>
    <tr><td>Wind direction</td><td>${weather && weather.wind_deg!==null && weather.wind_deg!==undefined ? weather.wind_deg + '¬∞' : '-'}</td></tr>
    <tr><td>Wind speed</td><td>${weather && weather.wind_speed!==null && weather.wind_speed!==undefined ? weather.wind_speed.toFixed(2) + ' m/s' : '-'}</td></tr>
    ${aqiObj ? `<tr><td>AQI</td><td>${aqiStr}</td></tr>` : ''}
    <tr><td colspan="2" style="text-align:center;">
      ${weather && weather.icon ? `<img class="weather-icon" src="${weatherIconUrl(weather.icon)}"/>` : ''}
      <span>${weather && weather.description ? weather.description : ''}</span>
    </td></tr>
  </table>`;
  return cityTitle + table;
}

// Show user's single marker (removes previous)
function createOrUpdateSingleMarker(lat, lon, label, measurements, weather){
  if(singleMarker) { map.removeLayer(singleMarker); singleMarker = null; }
  if(singleCircle) { map.removeLayer(singleCircle); singleCircle = null; }

  let pm = measurements.find(m=>m.parameter==='pm25'||m.parameter==='pm2.5');
  let color = pm ? chooseColorFromAQ(pm.value) : '#999';
  let radius = 60000;

  singleCircle = L.circle([lat, lon], {radius: radius, fillColor: color, color: color, fillOpacity: 0.4, weight:1}).addTo(map);
  singleMarker = L.marker([lat, lon]).addTo(map);

  singleMarker.bindPopup(buildPopupHtml(label,measurements,weather), {maxWidth: 340, minWidth: 240}).openPopup();
}

// Show city markers (persistent)
function createOrUpdateCityMarker(lat, lon, label, measurements, weather){
  let pm = measurements.find(m=>m.parameter==='pm25'||m.parameter==='pm2.5');
  let color = pm ? chooseColorFromAQ(pm.value) : '#999';
  let radius = 60000;
  let circle = L.circle([lat, lon], {radius: radius, fillColor: color, color: color, fillOpacity: 0.4, weight:1}).addTo(map);
  let marker = L.marker([lat, lon]).addTo(map);
  marker.bindPopup(buildPopupHtml(label,measurements,weather), {maxWidth: 340, minWidth: 240});
  cityMarkers.push({marker, circle});
}

// User marker fetch
async function fetchAndShowSingle(lat,lon,label){
  setStatus('Loading...');
  const [measurements,weather]=await Promise.all([fetchOpenAQ(lat,lon),fetchWeather(lat,lon)]);
  createOrUpdateSingleMarker(lat,lon,label,measurements,weather);
  setStatus('Data updated');
}

// City marker fetch
async function fetchAndShowCity(lat,lon,label){
  const [measurements,weather]=await Promise.all([fetchOpenAQ(lat,lon),fetchWeather(lat,lon)]);
  createOrUpdateCityMarker(lat,lon,label,measurements,weather);
}

// Big cities preload
const predefined=[
  {name:'New York',coords:[40.7128,-74.0060]},
  {name:'Los Angeles',coords:[34.0522,-118.2437]},
  {name:'Chicago',coords:[41.8781,-87.6298]},
  {name:'Toronto',coords:[43.6532,-79.3832]},
  {name:'Mexico City',coords:[19.4326,-99.1332]},
  {name:'Washington',coords:[38.9072,-77.0369]},
  {name:'Montreal',coords:[45.5019,-73.5674]},
  {name:'Dallas',coords:[32.7767,-96.7970]},
  {name:'Vancouver',coords:[49.2827,-123.1207]},
  {name:'San Francisco',coords:[37.7749,-122.4194]},
  {name:'Miami',coords:[25.7617,-80.1918]},
  {name:'Ottawa',coords:[45.4215,-75.6992]},
  {name:'Havana',coords:[23.1136,-82.3666]},
  {name:'Denver',coords:[39.7392,-104.9903]},
  {name:'Phoenix',coords:[33.4484,-112.0740]},
  {name:'Boston',coords:[42.3601,-71.0589]},
  {name:'Philadelphia',coords:[39.9526,-75.1652]},
  {name:'Houston',coords:[29.7604,-95.3698]},
  {name:'Seattle',coords:[47.6062,-122.3321]},
  {name:'Atlanta',coords:[33.7490,-84.3880]},
  {name:'Detroit',coords:[42.3314,-83.0458]},
  {name:'Minneapolis',coords:[44.9778,-93.2650]}
];
// On load, show all big cities
(async function(){
  setStatus('Loading cities...');
  for(const c of predefined){
    await new Promise(r=>setTimeout(r,180));
    fetchAndShowCity(c.coords[0],c.coords[1],c.name);
  }
  setStatus('All cities loaded');
})();

// Geocoder
if(typeof L.Control.Geocoder!=='undefined'){
  L.Control.geocoder({defaultMarkGeocode:false,placeholder:'Search for city or address...'}).on('markgeocode',function(e){
    const latlng=e.geocode.center;
    const name=e.geocode.name||'Place';
    map.setView(latlng,10);
    fetchAndShowSingle(latlng.lat,latlng.lng,name);
  }).addTo(map);
}
</script>
</body>
</html>
